from docx.oxml.ns import qn
from docx.oxml import OxmlElement

def add_outline_level(paragraph, level):
    """
    Manually sets the outline level of a paragraph so it appears in the TOC
    without changing its visual style to 'Heading X'.
    Level 0 = TOC Level 1, Level 1 = TOC Level 2, etc.
    """
    # Get or create the paragraph properties element (pPr)
    pPr = paragraph._p.get_or_add_pPr()
    
    # Create the outline level element
    outlineLvl = OxmlElement('w:outlineLvl')
    
    # Word outline levels are 0-based (0 is highest), usually max 9
    safe_level = min(max(0, level), 9)
    outlineLvl.set(qn('w:val'), str(safe_level))
    
    # Append to properties
    pPr.append(outlineLvl)


    def _process_list(self, list_element, level=1):
        """
        Processes lists. 
        - Ordered Lists (<ol>) -> styled as 'List Number', added to TOC.
        - Unordered Lists (<ul>) -> styled as 'List Bullet', NOT in TOC.
        """
        is_ordered = list_element.name == 'ol'
        
        # 1. Determine Style (Visual Look)
        base_style = 'List Number' if is_ordered else 'List Bullet'
        
        if level > 1:
            style_name = f"{base_style} {level}"
        else:
            style_name = base_style

        # 2. Iterate through items
        for li in list_element.find_all('li', recursive=False):
            
            # --- Extract Text ---
            text_parts = []
            nested_lists = []
            for child in li.contents:
                if child.name in ['ul', 'ol']:
                    nested_lists.append(child)
                else:
                    text_parts.append(child.get_text() if child.name else str(child))
            
            item_text = "".join(text_parts).strip()

            if item_text:
                try:
                    p = self.document.add_paragraph(item_text, style=style_name)
                except KeyError:
                    # Fallback if style "List Number 4" etc doesn't exist
                    p = self.document.add_paragraph(item_text, style=base_style)

                # --- The Logic Fix ---
                # Only add to TOC if it is an Ordered List (<ol>)
                if is_ordered:
                    # We map list level 1 -> TOC Level 0 (Main Heading)
                    # list level 2 -> TOC Level 1 (Sub Heading), etc.
                    add_outline_level(p, level - 1)

            # 3. Recursion
            for nested in nested_lists:
                self._process_list(nested, level=level + 1)



1. Introduction          <-- Starts with '1.', becomes 'List Number' + TOC Entry
2. System Design         <-- Starts with '2.', becomes 'List Number' + TOC Entry
   1. Database Schema    <-- Indented '1.', becomes 'List Number 2' + TOC Sub-Entry
   * User Table         <-- Bullet '*', becomes 'List Bullet'. NO TOC.
   * Order Table        <-- Bullet '*', becomes 'List Bullet'. NO TOC.
